<?php declare(strict_types=1);

/** @var \Hyva\Admin\Block\Adminhtml\HyvaGrid $block */
/** @var \Magento\Framework\Escaper $escaper */

$grid       = $block->getGrid();
$navigation = $grid->getNavigation();
$uniqueId = '_' . uniqid();
?>
<div class="antialiased sans-serif" x-data="initDataTable<?=$uniqueId?>()">

    <div class="max-w-full mx-auto py-6 px-0">
        <div class="mb-4 flex justify-between items-center">
            <div class="flex-1 pr-4">
                <div class="relative md:w-3/4 flex flex-wrap gap-x-8">
                    <div class="self-center">
                        <span class="font-medium text-md"><?= __('Current Page:')?></span>
                        <?= $navigation->getCurrentPageNumber() ?>
                    </div>

                    <div class="self-center">
                        <span class="font-medium text-md"><?= __('Total Pages:')?></span>
                        <?= $navigation->getPageCount() ?>
                    </div>

                    <div>
                        <label for="pageSize"><?= __('Rows Per Page:') ?></label>
                        <script>
                            function goToOptionUrl(option) {
                                const url = option.value;
                                if (url) {
                                    window.location.href=url;
                                }
                            }
                        </script>
                        <select id="pageSize" onchange="goToOptionUrl(this.selectedOptions[0])"
                                class="form-select @apply bg-white border border-gray-300 focus:ring-1 focus:ring-blue-500 focus:z-10 font-medium form-select hover:bg-gray-50 inline-flex items-center leading-loose py-2 relative rounded-md text-gray-700 text-xl">
                            <?php foreach ($navigation->getPageSizes() as $pageSize): ?>
                            <?php $currentPageSize = $navigation->getPageSize() === $pageSize ?>
                            <option value="<?= $navigation->getUrlForPageSize($pageSize) ?>" <?= $currentPageSize ? 'selected' : '' ?>><?= $pageSize ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div class="relative z-0 inline-flex shadow-sm rounded-md">
                        <?php if ($navigation->hasPreviousPage()): ?>
                            <a href="<?= $navigation->getPreviousPageUrl() ?>"
                            class="relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                Previous Page
                            </a>
                        <?php else: ?>
                            <span class="relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white font-medium text-gray-300 cursor-not-allowed">
                                Previous Page
                            </span>
                        <?php endif; ?>
                        <?php if ($navigation->hasNextPage()): ?>
                            <a href="<?= $navigation->getNextPageUrl() ?>"
                            class="-ml-px relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">Next Page</a>
                        <?php else: ?>
                            <span class="relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white font-medium text-gray-300 cursor-not-allowed">
                                Next Page
                            </span>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
            <div>
                <div class="flex">
                    <div class="relative">
                        <button @click.prevent="open = !open"
                                class="rounded-lg inline-flex items-center bg-white hover:text-blue-500 focus:outline-none focus:shadow-outline text-gray-500 font-semibold py-2 px-2 md:px-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 md:hidden md:visible" viewBox="0 0 24 24"
                                 stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                                 stroke-linejoin="round">
                                <rect x="0" y="0" width="24" height="24" stroke="none"></rect>
                                <path
                                    d="M5.5 5h13a1 1 0 0 1 0.5 1.5L14 12L14 19L10 16L10 12L5 6.5a1 1 0 0 1 0.5 -1.5" />
                            </svg>
                            <span class="hidden md:block md:visible">Display</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 ml-1" width="24" height="24"
                                 viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                 stroke-linecap="round" stroke-linejoin="round">
                                <rect x="0" y="0" width="24" height="24" stroke="none"></rect>
                                <polyline points="6 9 12 15 18 9" />
                            </svg>
                        </button>

                        <div x-show="open" @click.away="open = false"
                             class="z-40 absolute top-0 right-0 bg-white rounded-lg shadow-lg mt-16 -mr-1 block p-4 overflow-y-auto" style="max-height: 75vh;">
                            <template x-for="heading in headings">
                                <label
                                    class="flex justify-start items-center text-truncate hover:bg-gray-100 px-4 py-2">
                                    <div class="text-teal-600 mr-3">
                                        <input type="checkbox" class="form-checkbox focus:outline-none focus:shadow-outline" checked @click="toggleColumn(heading.key)">
                                    </div>
                                    <div class="select-none text-gray-700" x-text="heading.value"></div>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <?php if ($massActions = $grid->getMassActions()): ?>
            <?php $massActionFormId = 'hyva-grid-massaction-' . $grid->getGridName() ?>
            <form id="<?= $massActionFormId ?>" method="post">
                <script>
                    function doMassAction(option) {
                        const url = option.value;
                        const f = document.getElementById('<?= $massActionFormId ?>');
                        const checked = document.querySelectorAll('input[name="<?= $grid->getMassActionIdsParam() ?>[]"]:checked')
                        const select = f.querySelectorAll('select[name="massAction"]')[0];
                        if (! url) {
                            return;
                        }
                        if (checked.length === 0) {
                            alert('Please select the records to apply the mass action to.');
                            select.selectedIndex = 0;
                            return;
                        }
                        if (option.dataset.requireConfirm === 'true' && ! confirm('Are you sure?')) {
                            select.selectedIndex = 0;
                            return;
                        }
                        f.action = url;
                        f.submit();
                    }
                </script>
                <label for="massAction<?= $uniqueId?>" class="mr-8"><?= __('Mass Actions:') ?></label>
                <select onchange="doMassAction(this.selectedOptions[0])" id="massAction<?= $uniqueId ?>" name="massAction"
                        class="form-select @apply bg-white border border-gray-300 focus:ring-1 focus:ring-blue-500 focus:z-10 font-medium form-select hover:bg-gray-50 inline-flex items-center leading-loose py-2 relative rounded-md text-gray-700 text-xl"
                        form="<?= $massActionFormId ?>">
                    <option disabled selected hidden><?= __('Select an action') ?></option>
                    <?php foreach ($massActions as $massAction): ?>
                        <?php $massActionUrl = $block->getUrl($massAction->getUrl()) ?>
                        <option data-require-confirm="<?= $massAction->requireConfirmation() ? 'true' : 'false' ?>" value="<?= $massActionUrl ?>"><?= $massAction->getLabel() ?></option>
                    <?php endforeach; ?>
                </select>
                <?php if ($massActions) { ?></form><?php } ?>
                <?php endif; ?>
            </form>
            <?php if ($navigation->hasFilters()): ?>
            <form id="<?= $navigation->getFilterFormId() ?>" method="get" action="<?= $navigation->getFilterFormUrl() ?>">
                <input type="submit" hidden />
            </form>
            <?php endif; ?>
        </div>
    </div>

    <div class="flex flex-col">
        <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                <div class="overflow-hidden border-b border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                <thead>
                <tr class="text-left">

                    <?php if ($massActions): ?>
                        <th class="py-2 px-3 sticky top-0 border border-gray-200 bg-orange-950 text-gray-300">
                            <label
                                class="inline-flex justify-between items-center hover:bg-gray-200 px-2 py-2 rounded-lg cursor-pointer">
                                <input type="checkbox"
                                       class="form-checkbox focus:outline-none focus:shadow-outline"
                                       @click="selectAllCheckbox($event);">
                            </label>
                        </th>
                    <?php endif; ?>
                    <?php foreach ($grid->getColumnDefinitions() as $column): ?>
                    <?php $isSortedByColumn = $navigation->getSortByColumn() === $column->getKey() ?>
                    <?php $newDirection = $isSortedByColumn && $navigation->isSortOrderAscending() ? 'desc' : 'asc' ?>
                    <?php $sortIndicator = $isSortedByColumn ? ($navigation->isSortOrderAscending() ? '⬆️' : '⬇️') : '' ?>
                        <th class="<?= $escaper->escapeHtml($column->getKey()) ?> bg-orange-950 sticky top-0 border border-gray-200 px-6 py-2 text-gray-300 font-semibold tracking-wider uppercase text-xl table-cell align-middle"
                            x-ref="<?= $escaper->escapeHtml($column->getKey()) ?>"
                            onclick="window.location.href='<?= $navigation->getSortByUrl($column->getKey(), $newDirection) ?>'">
                            <?= $escaper->escapeHtml($column->getLabel()) ?> <?= $sortIndicator ?>
                        </th>
                    <?php endforeach; ?>
                    <?php if ($actions = $grid->getActions()): ?>
                        <th class="actions bg-orange-950 sticky top-0 border border-gray-200 px-6 py-2 text-gray-300 font-semibold tracking-wider uppercase text-xl table-cell align-middle">
                            <?= __('Actions') ?>
                        </th>
                    <?php endif; ?>
                </tr>
                <?php if ($navigation->hasFilters()): ?>
                <tr>
                    <?php if ($massActions): ?><th class="py-2 px-3 sticky top-0 border border-gray-200"></th><?php endif; ?>
                    <?php foreach ($grid->getColumnDefinitions() as $column): ?>
                    <th class="sticky top-0 border border-gray-200 px-6 py-2 text-gray-600 tracking-wider text-xl table-cell align-left">
                        <?php $filter = $navigation->getFilter($column->getKey()) ?>
                        <?= $filter ? $filter->getHtml() : '' ?>
                    </th>
                    <?php endforeach; ?>
                </tr>
                <?php endif; ?>
                </thead>
                <tbody>
                <?php foreach ($grid->getRows() as $row): ?>
                    <?php if ($rowAction = $actions[$grid->getRowActionId()] ?? false) {
                        $rowActionUrl       = $block->getUrl($rowAction->getUrl(), $rowAction->getParams($row));
                        $rowActionAttribute = sprintf(
                            "onclick=\"window.location.href='%s'\"",
                            $escaper->escapeJs($rowActionUrl)
                        );
                    } else {
                        $rowActionAttribute = '';
                    } ?>
                    <tr>
                        <?php if ($massActions): ?>
                            <td class="border border-gray-100 px-3">
                                <label
                                    class="text-teal-500 inline-flex justify-between items-center hover:bg-gray-200 px-2 py-2 rounded-lg cursor-pointer">
                                <input form="<?= $massActionFormId ?>"
                                       type="checkbox"
                                       value="<?= $row->getCell($grid->getMassActionIdColumn())->getRawValue() ?>"
                                       name="<?= $grid->getMassActionIdsParam() ?>[]"
                                       class="form-checkbox rowCheckbox focus:outline-none focus:shadow-outline"
                                       @click="selectRowCheckbox($event, '<?= $row->getCell($grid->getMassActionIdColumn())->getRawValue() ?>')"
                                />
                            </td>
                        <?php endif; ?>
                        <?php foreach ($row->getCells() as $cell): ?>
                            <td class=" <?= $escaper->escapeHtmlAttr($cell->getColumnDefinition()->getKey()); ?> border border-gray-100 px-3 table-cell align-middle whitespace-nowrap"
                                <?= $rowActionAttribute ?>>
                                <?= $cell->getHtml() ?>
                            </td>
                        <?php endforeach; ?>
                        <?php if ($actions): ?>
                            <td class="actions border border-gray-100 px-3 text-right">
                                <?php foreach ($actions as $action): ?>
                                    <a class=" text-blue-800 hover:text-blue-600 whitespace-no-wrap font-medium px-3" href="<?= $block->getUrl($action->getUrl(), $action->getParams($row)) ?>">
                                        <?= $escaper->escapeHtml($action->getLabel()) ?>
                                    </a>
                                <?php endforeach; ?>
                            </td>
                        <?php endif; ?>
                    </tr>
                <?php endforeach; ?>
                </tbody>
            </table>
    </div>
            </div>
        </div>
    </div>
</div>
    <script>
        function initDataTable<?=$uniqueId?>() {
            return {
                headings: [
                    <?php foreach ($grid->getColumnDefinitions() as $column): ?>
                    {
                        'key': '<?= $escaper->escapeHtml($column->getKey()) ?>',
                        'value': '<?= $escaper->escapeHtml($column->getLabel()) ?>'
                    },
                    <?php endforeach; ?>
                ],

                selectedRows: [],

                open: false,

                toggleColumn(key) {
                    let columns = document.querySelectorAll('.' + key);

                    if (this.$refs[key].classList.contains('hidden') && this.$refs[key].classList.contains(key)) {
                        columns.forEach(column => {
                            column.classList.remove('hidden');
                        });
                    } else {
                        columns.forEach(column => {
                            column.classList.add('hidden');
                        });
                    }
                },

                selectRowCheckbox($event, id) {
                    let rows = this.selectedRows;

                    if (rows.includes(id)) {
                        let index = rows.indexOf(id);
                        rows.splice(index, 1);
                    } else {
                        rows.push(id);
                    }
                },

                selectAllCheckbox($event) {
                    let columns = document.querySelectorAll('.rowCheckbox');

                    this.selectedRows = [];

                    if (!!$event.target.checked === true) {
                        columns.forEach(column => {
                            column.checked = true
                            this.selectedRows.push(parseInt(column.name))
                        });
                    } else {
                        columns.forEach(column => {
                            column.checked = false
                        });
                        this.selectedRows = [];
                    }
                }
            }
        }
    </script>
<div class="container mx-auto py-6 px-4">
    <?php if (!$grid->getRows()) { ?>
        <div>
            <?= __('No %1 found.', $grid->getEntityDefinition()->getLabelPlural()) ?>
        </div>
    <?php } ?>
</div>
